<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC
	"-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.nearme.statistics.dao.app.common.PvDao">
	
	<!-- 使用时长/单次-->
	<select id="listDurationTimes" parameterType="PvDTO" resultType="PvEntity">
	    SELECT T.DURATION, T.START_TIMES startTimes
		FROM DM_PV_DURATION_TIMES T LEFT JOIN(
			SELECT '1~3秒' DURATION, 1 TAG FROM DUAL
			UNION ALL
			SELECT '4~10秒' DURATION, 2 TAG FROM DUAL
			UNION ALL
			SELECT '11~30秒' DURATION, 3 TAG FROM DUAL
			UNION ALL
			SELECT '31~60秒' DURATION, 4 TAG FROM DUAL
			UNION ALL
			SELECT '1~3分' DURATION, 5 TAG FROM DUAL
			UNION ALL
			SELECT '3~10分' DURATION, 6 TAG FROM DUAL
			UNION ALL
			SELECT '10~30分' DURATION, 7 TAG FROM DUAL
			UNION ALL
			SELECT '大于30分' DURATION, 8 TAG FROM DUAL
		)T1 ON T.DURATION=T1.DURATION
		WHERE T.SYSTEM_ID=#{systemID} AND T.STATDATE=${statDateInt}
		      AND T.APP_VERSION=#{appVersion} AND T.CHANNEL_ID=#{channelID}
		ORDER BY T1.TAG
	</select>
	
	<!-- 对比使用时长/单次-->
	<select id="listDurationTimesCp" parameterType="PvDTO" resultType="PvEntity">
		SELECT STATDATE, SUM(CLUMN1) CLUMN1,SUM(CLUMN2) CLUMN2,SUM(CLUMN3) CLUMN3,
		       SUM(CLUMN4) CLUMN4,SUM(CLUMN5) CLUMN5,SUM(CLUMN6) CLUMN6,SUM(CLUMN7) CLUMN7,SUM(CLUMN8) CLUMN8
		FROM(
		SELECT T.STATDATE,
		       CASE WHEN T.DURATION='1~3秒' THEN T.START_TIMES ELSE 0 END CLUMN1,
		       CASE WHEN T.DURATION='4~10秒' THEN T.START_TIMES ELSE 0 END CLUMN2,
		       CASE WHEN T.DURATION='11~30秒' THEN T.START_TIMES ELSE 0 END CLUMN3,
		       CASE WHEN T.DURATION='31~60秒' THEN T.START_TIMES ELSE 0 END CLUMN4,
		       CASE WHEN T.DURATION='1~3分' THEN T.START_TIMES ELSE 0 END CLUMN5,
		       CASE WHEN T.DURATION='3~10分' THEN T.START_TIMES ELSE 0 END CLUMN6,
		       CASE WHEN T.DURATION='10~30分' THEN T.START_TIMES ELSE 0 END CLUMN7,
		       CASE WHEN T.DURATION='大于30分' THEN T.START_TIMES ELSE 0 END CLUMN8
		FROM DM_PV_DURATION_TIMES T 
		WHERE T.SYSTEM_ID=#{systemID} AND T.STATDATE in(${statDates})
		      AND T.APP_VERSION=#{appVersion} AND T.CHANNEL_ID=#{channelID}
		)M
		GROUP BY STATDATE
		ORDER BY STATDATE
	</select>
	
	<!-- 使用时长/单日-->
	<select id="listDurationImeis" parameterType="PvDTO" resultType="PvEntity">
	    SELECT T.DURATION, T.START_IMEIS startImeis
		FROM DM_PV_DURATION_IMEIS T LEFT JOIN(
			SELECT '1~3秒' DURATION, 1 TAG FROM DUAL
			UNION ALL
			SELECT '4~10秒' DURATION, 2 TAG FROM DUAL
			UNION ALL
			SELECT '11~30秒' DURATION, 3 TAG FROM DUAL
			UNION ALL
			SELECT '31~60秒' DURATION, 4 TAG FROM DUAL
			UNION ALL
			SELECT '1~3分' DURATION, 5 TAG FROM DUAL
			UNION ALL
			SELECT '3~10分' DURATION, 6 TAG FROM DUAL
			UNION ALL
			SELECT '10~30分' DURATION, 7 TAG FROM DUAL
			UNION ALL
			SELECT '大于30分' DURATION, 8 TAG FROM DUAL
		)T1 ON T.DURATION=T1.DURATION
		WHERE T.SYSTEM_ID=#{systemID} AND T.STATDATE=${statDateInt}
		      AND T.APP_VERSION=#{appVersion} AND T.CHANNEL_ID=#{channelID}
		ORDER BY T1.TAG
	</select>
	
	<!-- 对比使用时长/单日-->
	<select id="listDurationImeisCp" parameterType="PvDTO" resultType="PvEntity">
		SELECT STATDATE, SUM(CLUMN1) CLUMN1,SUM(CLUMN2) CLUMN2,SUM(CLUMN3) CLUMN3,
		       SUM(CLUMN4) CLUMN4,SUM(CLUMN5) CLUMN5,SUM(CLUMN6) CLUMN6,SUM(CLUMN7) CLUMN7,SUM(CLUMN8) CLUMN8
		FROM(
		SELECT T.STATDATE,
		       CASE WHEN T.DURATION='1~3秒' THEN T.START_IMEIS ELSE 0 END CLUMN1,
		       CASE WHEN T.DURATION='4~10秒' THEN T.START_IMEIS ELSE 0 END CLUMN2,
		       CASE WHEN T.DURATION='11~30秒' THEN T.START_IMEIS ELSE 0 END CLUMN3,
		       CASE WHEN T.DURATION='31~60秒' THEN T.START_IMEIS ELSE 0 END CLUMN4,
		       CASE WHEN T.DURATION='1~3分' THEN T.START_IMEIS ELSE 0 END CLUMN5,
		       CASE WHEN T.DURATION='3~10分' THEN T.START_IMEIS ELSE 0 END CLUMN6,
		       CASE WHEN T.DURATION='10~30分' THEN T.START_IMEIS ELSE 0 END CLUMN7,
		       CASE WHEN T.DURATION='大于30分' THEN T.START_IMEIS ELSE 0 END CLUMN8
		FROM DM_PV_DURATION_IMEIS T 
		WHERE T.SYSTEM_ID=#{systemID} AND T.STATDATE in(${statDates})
		      AND T.APP_VERSION=#{appVersion} AND T.CHANNEL_ID=#{channelID}
		)M
		GROUP BY STATDATE
		ORDER BY STATDATE
	</select>
	
	<!-- 使用频率-->
	<select id="listFrequency" parameterType="PvDTO" resultType="PvEntity">
	    SELECT FREQUENCY,SUM(T1.START_IMEIS) startImeis
		FROM(
		SELECT CASE WHEN T.FREQUENCY>=1 AND T.FREQUENCY&lt;=2 THEN '1-2' 
		            WHEN T.FREQUENCY>=3 AND T.FREQUENCY&lt;=5 THEN '3-5' 
		            WHEN T.FREQUENCY>=6 AND T.FREQUENCY&lt;=9 THEN '6-9'  
		            WHEN T.FREQUENCY>=10 AND T.FREQUENCY&lt;=19 THEN '10-19' 
		            WHEN T.FREQUENCY>=20 AND T.FREQUENCY&lt;=49 THEN '20-49' 
		            WHEN T.FREQUENCY>=50 AND T.FREQUENCY&lt;=99 THEN '50-99' 
		            WHEN T.FREQUENCY>=100 THEN '100+' 
		            ELSE 'OTHER' END FREQUENCY,
		       CASE WHEN T.FREQUENCY>=1 AND T.FREQUENCY&lt;=2 THEN 1 
		            WHEN T.FREQUENCY>=3 AND T.FREQUENCY&lt;=5 THEN 2 
		            WHEN T.FREQUENCY>=6 AND T.FREQUENCY&lt;=9 THEN 3  
		            WHEN T.FREQUENCY>=10 AND T.FREQUENCY&lt;=19 THEN 4 
		            WHEN T.FREQUENCY>=20 AND T.FREQUENCY&lt;=49 THEN 5 
		            WHEN T.FREQUENCY>=50 AND T.FREQUENCY&lt;=99 THEN 6 
		            WHEN T.FREQUENCY>=100 THEN 7 
		            ELSE 8 END TAG, T.START_IMEIS
		FROM DM_PV_FREQUENCY_${lidu} T
		WHERE T.SYSTEM_ID=#{systemID} AND T.STATDATE=${statDateInt}
		      AND T.APP_VERSION=#{appVersion} AND T.CHANNEL_ID=#{channelID}
		)T1 GROUP BY T1.FREQUENCY,T1.TAG ORDER BY TAG
	</select>
	
	<!-- 对比使用频率-->
	<select id="listFrequencyCp" parameterType="PvDTO" resultType="PvEntity">
		SELECT STATDATE, SUM(CLUMN1) CLUMN1,SUM(CLUMN2) CLUMN2,SUM(CLUMN3) CLUMN3,
		       SUM(CLUMN4) CLUMN4,SUM(CLUMN5) CLUMN5,SUM(CLUMN6) CLUMN6,SUM(CLUMN7) CLUMN7
		FROM(
		    SELECT T.STATDATE,
		           CASE WHEN T.FREQUENCY>=1 AND T.FREQUENCY&lt;=2 THEN T.START_IMEIS ELSE 0 END CLUMN1,
		           CASE WHEN T.FREQUENCY>=3 AND T.FREQUENCY&lt;=5 THEN T.START_IMEIS ELSE 0 END CLUMN2,
		           CASE WHEN T.FREQUENCY>=6 AND T.FREQUENCY&lt;=9 THEN T.START_IMEIS ELSE 0 END CLUMN3,
		           CASE WHEN T.FREQUENCY>=10 AND T.FREQUENCY&lt;=19 THEN T.START_IMEIS ELSE 0 END CLUMN4,
		           CASE WHEN T.FREQUENCY>=20 AND T.FREQUENCY&lt;=49 THEN T.START_IMEIS ELSE 0 END CLUMN5,
		           CASE WHEN T.FREQUENCY>=50 AND T.FREQUENCY&lt;=99 THEN T.START_IMEIS ELSE 0 END CLUMN6,
		           CASE WHEN T.FREQUENCY>=100 THEN T.START_IMEIS ELSE 0 END CLUMN7
		    FROM DM_PV_FREQUENCY_${lidu} T
		    WHERE T.SYSTEM_ID=#{systemID} AND T.STATDATE in(${statDates})
		          AND T.APP_VERSION=#{appVersion} AND T.CHANNEL_ID=#{channelID}
		)T1 GROUP BY STATDATE ORDER BY STATDATE
	</select>
	
	<!-- 访问页面数 -->
	<select id="listVistPages" parameterType="PvDTO" resultType="PvEntity">
	    SELECT VISIT_PAGES visitPages,SUM(T1.START_TIMES) startTimes
		FROM(
		SELECT CASE WHEN T.VISIT_PAGES>=1 AND T.VISIT_PAGES&lt;=2 THEN '1-2' 
		            WHEN T.VISIT_PAGES>=3 AND T.VISIT_PAGES&lt;=5 THEN '3-5' 
		            WHEN T.VISIT_PAGES>=6 AND T.VISIT_PAGES&lt;=9 THEN '6-9'  
		            WHEN T.VISIT_PAGES>=10 AND T.VISIT_PAGES&lt;=29 THEN '10-29' 
		            WHEN T.VISIT_PAGES>=30 AND T.VISIT_PAGES&lt;=99 THEN '30-99' 
		            WHEN T.VISIT_PAGES>=100 THEN '100+' 
		            ELSE 'OTHER' END VISIT_PAGES,
		       CASE WHEN T.VISIT_PAGES>=1 AND T.VISIT_PAGES&lt;=2 THEN 1 
		            WHEN T.VISIT_PAGES>=3 AND T.VISIT_PAGES&lt;=5 THEN 2 
		            WHEN T.VISIT_PAGES>=6 AND T.VISIT_PAGES&lt;=9 THEN 3  
		            WHEN T.VISIT_PAGES>=10 AND T.VISIT_PAGES&lt;=29 THEN 4
		            WHEN T.VISIT_PAGES>=30 AND T.VISIT_PAGES&lt;=99 THEN 5 
		            WHEN T.VISIT_PAGES>=100 THEN 6 
		            ELSE 7 END TAG, T.START_TIMES
		FROM DM_PV_VISIT_PAGES T
		WHERE T.SYSTEM_ID=#{systemID} AND T.STATDATE>=${startDateInt} AND T.STATDATE&lt;=${endDateInt}
		<if test="appVersion!=null and appVersion!='' and appVersion!='all'">
		      AND T.APP_VERSION=#{appVersion} 
		</if>
		<if test="channelID!=null and channelID!='' and channelID!='all'">
		      AND T.CHANNEL_ID=#{channelID} 
		</if>
		)T1 GROUP BY T1.VISIT_PAGES,T1.TAG ORDER BY TAG
	</select>
	
	<!-- 当前页面访问情况  -->
	<select id="listCurPageVisit" parameterType="PvDTO" resultType="VisitPathEntity">
	    SELECT T.CUR_PAGE CURPAGE,SUM(T.JUMP_TIMES) JUMPTIMES,SUM(T.DURATION) DURATION,SUM(T.EXIT_TIMES) EXITTIMES
		FROM DM_PV_VISIT_PATH T
		WHERE T.STATDATE >= ${startDateInt} AND T.STATDATE &lt;= ${endDateInt}
		      AND T.SYSTEM_ID=#{systemID} AND T.NEXT_PAGE='ALL'
		      AND T.APP_VERSION=#{appVersion} 
		GROUP BY T.CUR_PAGE
		ORDER BY 2 DESC
	</select>
	
	<!-- 当前页面跳转情况  -->
	<select id="listCurPageJump" parameterType="PvDTO" resultType="VisitPathEntity">
	    SELECT T.NEXT_PAGE NEXTPAGE, SUM(T.JUMP_TIMES) JUMPTIMES
		FROM DM_PV_VISIT_PATH T
		WHERE T.STATDATE >= ${startDateInt} AND T.STATDATE &lt;= ${endDateInt}
		      AND T.SYSTEM_ID=#{systemID}
		      AND T.CUR_PAGE=#{curPage}
		      AND T.APP_VERSION=#{appVersion} 
		      AND T.NEXT_PAGE!='ALL'
		GROUP BY T.NEXT_PAGE
		ORDER BY 2 DESC
	</select>
	
</mapper>